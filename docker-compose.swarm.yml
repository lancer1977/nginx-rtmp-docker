version: "3.8"

services:
  rtmp:
    image: tiangolo/nginx-rtmp:latest-2026-02-09
    # For local builds, use your built image:
    # image: nginx-rtmp:latest
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    environment:
      PUID: "1000"
      PGID: "1000"
      TZ: "US/Eastern"
    ports:
      - "1935:1935"   # RTMP ingest
      - "8088:80"     # HTTP out (player + HLS)
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - rtmp_hls:/var/www/hls
      - ./html:/var/www/html:ro
    networks:
      - rtmp_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  rtmp_network:
    driver: overlay
    attachable: true

volumes:
  rtmp_hls:
    driver: local
