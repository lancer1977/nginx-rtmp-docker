worker_processes auto;
rtmp_auto_push on;
events {}

rtmp {
    server {
        listen 1935;
        listen [::]:1935 ipv6only=on;

        application live {
            live on;
            record off;

            # HLS fragment and playlist settings
            hls on;
            hls_path /var/www/hls;
            hls_fragment 3;
            hls_playlist_length 60;
            hls_continuous on;
            hls_cleanup on;
            hls_nested on;

            # Allow all publishers (in production, consider adding auth)
            allow publish all;
            allow play all;
        }
    }
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    sendfile on;
    keepalive_timeout 65;

    # HTTP server for playback pages and HLS
    server {
        listen 80;
        listen [::]:80 ipv6only=on;
        server_name _;

        # Root - landing page with stream list
        location = / {
            root /var/www/html;
            index index.html;
            try_files /index.html =404;
        }

        # Stream player pages - /live/broadcastername
        location ~ ^/live/([^/]+)$ {
            root /var/www/html;
            index player.html;
            try_files /player.html =404;

            # Pass stream name to JavaScript via rewrite
            set $stream_name $1;
            rewrite ^/live/(.*)$ /player.html?stream=$1 break;
        }

        # HLS streams - /hls/broadcastername.m3u8
        location ~ ^/hls/(.*\.m3u8)$ {
            alias /var/www/hls/$1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";

            # CORS headers for cross-origin playback
            add_header 'Access-Control-Allow-Origin' '*';
        }

        # HLS segments - /hls/broadcastername-*.ts
        location ~ ^/hls/(.*\.ts)$ {
            alias /var/www/hls/$1;
            add_header Cache-Control "max-age=3600";

            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*';
        }

        # RTMP stats page
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }

        # RTMP control (for disconnecting streams, etc)
        location /control {
            rtmp_control all;
        }

        # Admin/management endpoint
        location /admin {
            return 200 'nginx-rtmp streaming server\n\nActive streams: see /stat';
            add_header Content-Type text/plain;
        }

        # Health check
        location = /healthz {
            return 200 'ok';
            add_header Content-Type text/plain;
        }

        # Static files (fallback)
        location / {
            root /var/www/html;
            index index.html;
        }
    }
}
