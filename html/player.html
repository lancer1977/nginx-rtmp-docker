<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Player</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f0f0f;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 15px 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header a {
            color: #00ff88;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .header a:hover {
            text-decoration: underline;
        }
        .stream-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .stream-title span {
            color: #00ff88;
        }
        .player-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        video {
            max-width: 100%;
            max-height: 80vh;
            background: #000;
            border-radius: 8px;
        }
        .error {
            text-align: center;
            color: #ff4444;
            padding: 40px;
        }
        .error h2 {
            margin-bottom: 15px;
        }
        .error p {
            color: #888;
        }
        .loading {
            text-align: center;
            color: #888;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .stream-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #888;
        }
        .stream-info code {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            color: #00ff88;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/">‚Üê Back to Streams</a>
        <div class="stream-title">Stream: <span id="streamName">...</span></div>
        <div></div>
    </div>

    <div class="player-container">
        <div id="player">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading player...</p>
            </div>
        </div>
    </div>

    <div class="stream-info">
        RTMP: <code>rtmp://[host]/live/<span id="rtmpName"></span></code>
    </div>

    <!-- HLS.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <script>
        // Get stream name from URL query parameter
        const urlParams = new URLSearchParams(window.location.search);
        let streamName = urlParams.get('stream') || '';
        
        // Update page elements
        document.getElementById('streamName').textContent = streamName;
        document.getElementById('rtmpName').textContent = streamName;
        document.title = streamName + ' - Stream Player';

        const playerDiv = document.getElementById('player');

        if (!streamName) {
            playerDiv.innerHTML = `
                <div class="error">
                    <h2>No Stream Specified</h2>
                    <p>Please specify a stream name in the URL: /live/streamname</p>
                </div>
            `;
        } else {
            // Create video element
            const video = document.createElement('video');
            video.controls = true;
            video.autoplay = true;
            video.muted = false;
            video.style.maxWidth = '100%';
            video.style.maxHeight = '80vh';

            playerDiv.innerHTML = '';
            playerDiv.appendChild(video);

            const hlsUrl = `/hls/${streamName}.m3u8`;

            if (Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                });

                hls.loadSource(hlsUrl);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    console.log('HLS manifest loaded');
                    video.play().catch(e => {
                        console.log('Auto-play blocked:', e.message);
                    });
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS error:', data);
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                playerDiv.innerHTML = `
                                    <div class="error">
                                        <h2>Connection Error</h2>
                                        <p>Unable to load stream. The broadcaster may be offline.</p>
                                    </div>
                                `;
                                hls.destroy();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                playerDiv.innerHTML = `
                                    <div class="error">
                                        <h2>Media Error</h2>
                                        <p>Error decoding stream. Trying to recover...</p>
                                    </div>
                                `;
                                hls.recoverMediaError();
                                break;
                            default:
                                playerDiv.innerHTML = `
                                    <div class="error">
                                        <h2>Stream Unavailable</h2>
                                        <p>The stream "${escapeHtml(streamName)}" is not available.</p>
                                        <p style="margin-top:10px">Stream to <code>rtmp://[host]/live/${escapeHtml(streamName)}</code> to start broadcasting.</p>
                                    </div>
                                `;
                                hls.destroy();
                                break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari)
                video.src = hlsUrl;
                video.addEventListener('loadedmetadata', function() {
                    video.play().catch(e => {
                        console.log('Auto-play blocked:', e.message);
                    });
                });
            } else {
                playerDiv.innerHTML = `
                    <div class="error">
                        <h2>HLS Not Supported</h2>
                        <p>Your browser does not support HLS playback.</p>
                        <p style="margin-top:10px">Try using Chrome, Firefox, or Safari.</p>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
